# 微信小程序登录流程说明

## 登录流程概述

本项目采用微信官方推荐的登录流程：**code -> openid**，实现无感知自动登录。

## 详细登录流程

### 应用启动时 (app.js onLaunch)

1. **自动触发登录流程**
   - 小程序启动时自动调用 `autoLogin()` 方法
   - 用户无感知，不需要任何操作

2. **检查本地缓存**
   - 检查本地是否有有效的登录缓存（openid、userInfo、loginTime）
   - 如果缓存未过期（7天有效期），直接使用缓存数据
   - 异步刷新用户状态

3. **静默登录（如果缓存无效或过期）**
   - **登录流程（1）**：调用 `wx.login()` 获取临时登录凭证 code
   - **登录流程（2）**：将 code 发送到后台服务器 `http://192.168.79.1:8080/api/wx/login`
   - **登录流程（3）**：使用获得的 openid 拉取用户状态（菜单权限等）`/api/user/status`
   - **登录流程（4）**：更新用户信息
   - **登录流程（5）**：登录完成，更新全局状态

### 页面加载时 (home.js onLoad)

1. **自动加载用户数据**
   - 页面加载时调用 `loadPageData()`
   - 自动获取已登录的用户信息
   - 如果用户正在登录中，会等待2秒后重新加载数据

2. **加载需要登录的数据**
   - 今日统计数据
   - 用户小摊状态
   - 用户权限菜单

## 后台接口要求

### 1. 微信登录接口
```
POST http://192.168.79.1:8080/api/auth/login
Content-Type: application/json

{
  "code": "微信登录code"
}

响应格式：
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "openid": "用户openid",
    "session_key": "会话密钥",
    "userInfo": {
      "nickName": "用户昵称",
      "avatarUrl": "用户头像"
    }
  }
}
```

### 2. 用户状态接口
```
GET http://192.168.79.1:8080/api/user/status?openid=用户openid

响应格式：
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "userStatus": {
      "role": "用户角色",
      "permissions": ["权限列表"],
      "menus": ["菜单权限"]
    },
    "profile": {
      "phone": "手机号",
      "email": "邮箱"
    }
  }
}
```

### 3. 今日统计接口
```
GET http://192.168.79.1:8080/api/stats/today?openid=用户openid

响应格式：
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "sales": 12,
    "revenue": "258.50",
    "visitors": 47
  }
}
```

## 登录状态管理

### 本地存储
- `openid`: 用户唯一标识
- `userInfo`: 用户基本信息
- `session_key`: 会话密钥
- `loginTime`: 登录时间（用于判断过期）

### 全局状态
- `app.globalData.loginStatus`: 登录状态
- `app.globalData.openid`: 用户openid
- `app.globalData.userInfo`: 用户信息

### 过期处理
- 登录缓存有效期：7天
- 过期后自动清除缓存，重新登录
- 登录失败时应用仍可使用，但功能受限

## 用户操作

### 1. 获取详细用户信息
- 点击用户头像可以获取更详细的用户信息（需要用户授权）
- 调用 `wx.getUserProfile()` 获取昵称、头像等

### 2. 退出登录
- 在个人中心可以选择退出登录
- 清除本地缓存和全局状态
- 退出后下次启动会自动重新登录

## 特点

1. **无感知登录**: 用户无需手动登录，应用启动自动完成
2. **静默处理**: 登录过程在后台进行，不影响用户使用
3. **容错机制**: 登录失败时应用仍可基础使用
4. **状态同步**: 登录后自动拉取用户状态和权限
5. **缓存机制**: 本地缓存减少重复登录请求

## 注意事项

1. 确保 `192.168.79.1:8080` 后台服务正常运行
2. 后台需要配置微信小程序的 AppID 和 AppSecret
3. 确保网络环境可以访问后台服务器
4. 建议在生产环境中使用 HTTPS 协议